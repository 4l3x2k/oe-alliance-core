From f307614fd824ab22c6cc07836ae29017164ecbc6 Mon Sep 17 00:00:00 2001
From: Captain <captain.onboard@web.de>
Date: Sat, 17 Nov 2018 09:44:09 +0100
Subject: [PATCH] fix

---
 .../airdigitalemmc_image_multi.bbclass        |  4 +---
 .../airdigitalemmc_image_single.bbclass       |  4 +---
 .../meta-airdigital/conf/machine/h9combo.conf |  2 +-
 .../conf/machine/include/airdigital-oem.inc   |  1 +
 .../airdigital-fastboot-3798mv200.bb          |  2 +-
 .../recipes-bsp/resizerootfs.bb               | 20 +++++++++++++++++++
 .../recipes-bsp/resizerootfs/h7/resizerootfs  | 13 ++++++++++++
 .../resizerootfs/h9combo/resizerootfs         | 19 ++++++++++++++++++
 .../meta-edision/recipes-bsp/resizerootfs.bb  |  2 +-
 9 files changed, 58 insertions(+), 9 deletions(-)
 create mode 100644 meta-brands/meta-airdigital/recipes-bsp/resizerootfs.bb
 create mode 100644 meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h7/resizerootfs
 create mode 100644 meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h9combo/resizerootfs

diff --git a/meta-brands/meta-airdigital/classes/airdigitalemmc_image_multi.bbclass b/meta-brands/meta-airdigital/classes/airdigitalemmc_image_multi.bbclass
index 1667e417e..27315c198 100644
--- a/meta-brands/meta-airdigital/classes/airdigitalemmc_image_multi.bbclass
+++ b/meta-brands/meta-airdigital/classes/airdigitalemmc_image_multi.bbclass
@@ -67,7 +67,5 @@ IMAGE_CMD_airdigitalemmc () {
     mcopy -i ${WORKDIR}/boot.img -v ${WORKDIR}/STARTUP_4 ::
     dd conv=notrunc if=${WORKDIR}/boot.img of=${EMMC_IMAGE} bs=${BLOCK_SIZE} seek=$(expr ${BOOT_PARTITION_OFFSET} \* ${BLOCK_SECTOR})
     dd conv=notrunc if=${DEPLOY_DIR_IMAGE}/zImage of=${EMMC_IMAGE} bs=${BLOCK_SIZE} seek=$(expr ${KERNEL_PARTITION_OFFSET} \* ${BLOCK_SECTOR})
-    resize2fs ${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ext4 ${ROOTFS_PARTITION_SIZE}k
-    # Truncate on purpose
-    dd if=${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ext4 of=${EMMC_IMAGE} bs=${BLOCK_SIZE} seek=$(expr ${ROOTFS_PARTITION_OFFSET} \* ${BLOCK_SECTOR}) count=$(expr ${IMAGE_ROOTFS_SIZE} \* ${BLOCK_SECTOR})
+    dd if=${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ext4 of=${EMMC_IMAGE} bs=${BLOCK_SIZE} seek=$(expr ${ROOTFS_PARTITION_OFFSET} \* ${BLOCK_SECTOR})
 }
\ No newline at end of file
diff --git a/meta-brands/meta-airdigital/classes/airdigitalemmc_image_single.bbclass b/meta-brands/meta-airdigital/classes/airdigitalemmc_image_single.bbclass
index abbd37cb8..a7b9a5120 100644
--- a/meta-brands/meta-airdigital/classes/airdigitalemmc_image_single.bbclass
+++ b/meta-brands/meta-airdigital/classes/airdigitalemmc_image_single.bbclass
@@ -38,7 +38,5 @@ IMAGE_CMD_airdigitalemmc () {
     mcopy -i ${WORKDIR}/boot.img -v ${WORKDIR}/STARTUP_1 ::
     dd conv=notrunc if=${WORKDIR}/boot.img of=${EMMC_IMAGE} bs=1024 seek=${BOOT_PARTITION_OFFSET}
     dd conv=notrunc if=${DEPLOY_DIR_IMAGE}/zImage of=${EMMC_IMAGE} bs=1024 seek=${KERNEL_PARTITION_OFFSET}
-    resize2fs ${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ext4 ${ROOTFS_PARTITION_SIZE}k
-    # Truncate on purpose
-    dd if=${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ext4 of=${EMMC_IMAGE} bs=1024 seek=${ROOTFS_PARTITION_OFFSET} count=${IMAGE_ROOTFS_SIZE}
+    dd if=${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ext4 of=${EMMC_IMAGE} bs=${BLOCK_SIZE} seek=$(expr ${ROOTFS_PARTITION_OFFSET} \* ${BLOCK_SECTOR})
 }
diff --git a/meta-brands/meta-airdigital/conf/machine/h9combo.conf b/meta-brands/meta-airdigital/conf/machine/h9combo.conf
index 0bdba1a95..1f44a5205 100644
--- a/meta-brands/meta-airdigital/conf/machine/h9combo.conf
+++ b/meta-brands/meta-airdigital/conf/machine/h9combo.conf
@@ -15,7 +15,7 @@ ROOTFS_FILE = "rootfs.ubi"
 
 IMAGE_FSTYPES += " fastboot4gb"
 
-MACHINE_FEATURES += " hisil-3798mv200 mali skins1080 multitranscoding kodi himedia no-subssupport blindscan-dvbs dvb-c ci"
+MACHINE_FEATURES += " hisil-3798mv200 mali emmc skins1080 multitranscoding kodi himedia no-subssupport blindscan-dvbs dvb-c ci"
 
 EXTRA_OECONF_append_pn-enigma2 += " --with-alphablendingacceleration=always --with-blitaccelerationthreshold=250  --with-fillaccelerationthreshold=190000"
 
diff --git a/meta-brands/meta-airdigital/conf/machine/include/airdigital-oem.inc b/meta-brands/meta-airdigital/conf/machine/include/airdigital-oem.inc
index 0abf36437..64fc18727 100644
--- a/meta-brands/meta-airdigital/conf/machine/include/airdigital-oem.inc
+++ b/meta-brands/meta-airdigital/conf/machine/include/airdigital-oem.inc
@@ -148,6 +148,7 @@ MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS = "\
     ${@bb.utils.contains('MACHINE_FEATURES', 'qtegls', 'airdigital-qteglfs-platform', '',d)} \
     ${@bb.utils.contains('MACHINE_FEATURES', 'swap', 'airdigital-swapcreate', '',d)} \
     ${@bb.utils.contains('MACHINE_FEATURES', 'mali', 'airdigital-mali-${HICHIPSET} kernel-module-mali-${HICHIPSET}' , '', d)} \
+    ${@bb.utils.contains('MACHINE_FEATURES', 'emmc', 'resizerootfs' , '', d)} \
     "
 
 MACHINE_EXTRA_RRECOMMENDS = " \
diff --git a/meta-brands/meta-airdigital/recipes-bsp/airdigital-fastboot-3798mv200.bb b/meta-brands/meta-airdigital/recipes-bsp/airdigital-fastboot-3798mv200.bb
index 68a6c3d02..1d6c91a95 100644
--- a/meta-brands/meta-airdigital/recipes-bsp/airdigital-fastboot-3798mv200.bb
+++ b/meta-brands/meta-airdigital/recipes-bsp/airdigital-fastboot-3798mv200.bb
@@ -1,6 +1,6 @@
 SRCDATE = "20181107"
 
-require zgemma-fastboot.inc
+require airdigital-fastboot.inc
 
 SRC_URI[md5sum] = "2fa81338f15fe1c068bfcd0343f8e9f6"
 SRC_URI[sha256sum] = "18c9716b7c7bddf573622ed6da4869a099d862d7490df7fdb00f9b6f8f918862"
diff --git a/meta-brands/meta-airdigital/recipes-bsp/resizerootfs.bb b/meta-brands/meta-airdigital/recipes-bsp/resizerootfs.bb
new file mode 100644
index 000000000..5847537e6
--- /dev/null
+++ b/meta-brands/meta-airdigital/recipes-bsp/resizerootfs.bb
@@ -0,0 +1,20 @@
+DESCRIPTION = "Resize Rootfs"
+require conf/license/license-gplv2.inc
+
+COMPATIBLE_MACHINE = "osmio4k"
+
+RDEPENDS_${PN} = "e2fsprogs-resize2fs"
+PV = "1.0"
+PR = "r0"
+
+SRC_URI = "file://resizerootfs"
+
+inherit update-rc.d
+
+INITSCRIPT_NAME = "resizerootfs"
+INITSCRIPT_PARAMS = "start 7 S ."
+
+do_install () {
+    install -m 0755 -d ${D}${sysconfdir}/init.d
+    install -m 0755 ${WORKDIR}/resizerootfs ${D}${sysconfdir}/init.d/resizerootfs
+}
diff --git a/meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h7/resizerootfs b/meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h7/resizerootfs
new file mode 100644
index 000000000..1c11b96ee
--- /dev/null
+++ b/meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h7/resizerootfs
@@ -0,0 +1,13 @@
+#!/bin/sh
+
+if ! test -e /.resizerootfs
+then
+    if grep -q mmcblk1p3 /proc/cmdline
+    then
+        echo "Resizing /dev/mmcblkp3, Do not unplug power!..."
+        resize2fs /dev/mmcblk1p3
+        touch /.resizerootfs
+    fi
+fi
+
+: exit 0
diff --git a/meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h9combo/resizerootfs b/meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h9combo/resizerootfs
new file mode 100644
index 000000000..21f051635
--- /dev/null
+++ b/meta-brands/meta-airdigital/recipes-bsp/resizerootfs/h9combo/resizerootfs
@@ -0,0 +1,19 @@
+#!/bin/sh
+
+if ! test -e /.resizerootfs
+then
+    if grep -q mmcblk0p12 /proc/cmdline
+    then
+        echo "Resizing /dev/mmcblk0p12, Do not unplug power!..."
+        resize2fs /dev/mmcblk0p12
+        touch /.resizerootfs
+    fi
+    if grep -q mmcblk0p14 /proc/cmdline
+    then
+        echo "Resizing /dev/mmcblk0p14, Do not unplug power!..."
+        resize2fs /dev/mmcblk0p14
+        touch /.resizerootfs
+    fi
+fi
+
+: exit 0
diff --git a/meta-brands/meta-edision/recipes-bsp/resizerootfs.bb b/meta-brands/meta-edision/recipes-bsp/resizerootfs.bb
index 5847537e6..c9ed7ad31 100644
--- a/meta-brands/meta-edision/recipes-bsp/resizerootfs.bb
+++ b/meta-brands/meta-edision/recipes-bsp/resizerootfs.bb
@@ -1,7 +1,7 @@
 DESCRIPTION = "Resize Rootfs"
 require conf/license/license-gplv2.inc
 
-COMPATIBLE_MACHINE = "osmio4k"
+COMPATIBLE_MACHINE = "^(h9combo|h7)$"
 
 RDEPENDS_${PN} = "e2fsprogs-resize2fs"
 PV = "1.0"
-- 
2.19.1.windows.1

